<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Joker Online</title>
    <link rel="stylesheet" href="node_modules/deck-of-cards/example/example.css">
</head>
<body>
    <div id="main">
        <g>
            <div id="container"></div>
        </g>
        <div id="topbar"></div><a href="https://github.com/pakastin/deck-of-cards">
    <script src="node_modules/deck-of-cards/dist/deck.min.js"></script>

    <script>

        class Card {
            constructor(value, suit) {
                this.value = value;
                this.suit = suit;
            }
        }

        
        class StandardJokerDeck {
            constructor() {
                this.suits = [0, 1, 2, 3]; // Diamonds, Clubs, Hearts, Spades
                this.values = [7, 8, 9, 10, 11, 12, 13, 14];
                this.cards = [];
                for (var i = 0; i < this.suits.length; i++){ // suits 0 - 3 (H,D,S,C)
                    for (var j = 0; j < this.values.length; j++){ // values 7 - Ace
                        this.cards.push(new Card(j, i));
                    }
                }
                
                // Add Sixes
                this.cards.push(new Card(6, 0));
                this.cards.push(new Card(6, 2));
            
                // Add Jokers
                this.cards.push(new Card(13, 1));
                this.cards.push(new Card(13, 3));
            }

            shuffle(){
                this.cards.sort(() => (Math.random() > .5) ? 1 : -1);
            }

            get(index){
                return this.cards[index];
            }
            
            deal(location, number){
                for(var i = 0; i < number; i++)
                location.push(this.cards.pop());
            }
        }


        class Player {
            constructor(id_in){
                this.id = id_in;
                this.score = 0;
                this.cards = [];
                this.called = 0;
                this.taken = 0;
            }
        }

        class Game { 
            constructor() { 
                this.deck = new StandardJokerDeck();
                this.wildcard = new Card(0,0);
                this.first_suit = new Card(0,5);
                this.cards_dealt = 0;
                this.round = 0;
                this.play = 0;
                this.users = [new Player(0), new Player(1), new Player(2), new Player(3)];
                this.dealer = Math.floor(Math.random() * 4);
                // this.simulation = Boolean(false);
                // this.model = None
            }

            get_place_in_playing_order(player_id){
                var dealer = this.dealer;
                var out = 5;
                for (var i = 1; i < 6; i++){
                    if ((dealer + i) % 4 == player_id){
                        out = i;
                    }
                }
                return out;
            }

            get_wildsuit(){
                if (this.wildcard.value != 13){
                    return this.wildcard.suit;
                } else {
                    return 4;
                }
            }

            set_dealer(){
                this.dealer = (this.dealer + 1) % 4;
            }

            update_round(){ 
                this.set_dealer();
                
                if (this.round == 1 && this.play == 8){
                    this.round += 1;
                    this.play = 1;
                } else if (this.round == 0 && this.play == 0) {
                    this.round = 1;
                    this.play = 1;
                } else if (this.round == 2 && this.play == 4) {
                    this.round = 3;
                    this.play = 1;
                } else if (this.round == 3 && this.play == 8 ) {
                    this.round = 4;
                    this.play = 1;
                } else {
                    this.play += 1;
                }

                if (this.round == 1 || this.round == 3) {
                    this.cards_dealt = this.play;
                } else {
                    this.cards_dealt = 9;
                }
            }

            set_calls(u0, u1, u2, u3){
                this.users[0].called = u0;
                this.users[1].called = u1;
                this.users[2].called = u2;
                this.users[3].called = u3;
            }

            get_play_index_of_game(){
                if (this.round == 1) {
                    return (this.play - 1);
                } else if (this.round == 2) {
                    return (this.play + 7);
                } else if (this.round == 3) {
                    return (this.play + 11);
                } else if (this.round == 4) {
                    return (this.play + 19);
                } else {
                    return 100;
                }
            }

            deal_to_users(){
                this.deck.shuffle()
                for (var i = 0; i < 4; i++) {
                    this.deck.deal(this.users[i], this.cards_dealt);
                }
            }
            
            set_wildcard() {
                var choice, choices;

                if (this.round === 2 || this.round === 4) {
                    choices = this.users[(this.dealer + 1) % 4].cards.slice(0, 3);
                    choice = this.get_wild_choice(choices, dealer);
                    this.wildcard = choices[choice];
                } else {
                    this.wildcard = this.deck[0];
                }
            }

            card_to_weight(card) {
                var weight;
                weight = 0;

                if (card.suit === this.get_wildsuit()) {
                    weight += 200;
                } else {
                    if (card.suit === this.first_suit) {
                    weight += 100;
                    }
                }

                if (card.value === 13) {
                    weight += 400;
                } else {
                    weight += (card.value);
                }

                return weight;
            }

            compute_winner(played) {
                var jok, joks, weights;
                jok = 5;
                joks = 0;

                for (var i = 1; i < 5; i += 1) {
                    if (played[(this.dealer + i) % 4].value === 13) {
                        jok = (this.dealer + i) % 4;
                        joks += 1;
                    }
                }

                if (joks === 2) {
                    return jok;
                } else {
                    weights = [];

                    for (var i = 0; i < 4; i++) {
                        weights.push(this.card_to_weight(played[i]));
                    }

                    return weights.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1];
                }
            }

            playable(player, wildsuit, first_suit) {
                var firsts, joks, wilds;
                firsts = list(filter(x => {
                    return x.suit === first_suit && !(x.value === 13);
                }, this.users[player].cards));
                wilds = list(filter(x => {
                    return x.suit === wildsuit && !(x.value === 13);
                }, this.users[player].cards));
                joks = list(filter(x => {
                    return x.value === 13;
                }, this.users[player].cards));

                if (this.first_suit === null) {
                    return this.users[player].cards;
                } else {
                    if (firsts === []) {
                        if (wilds === []) {
                            return this.users[player].cards;
                        } else {
                            for (var i = 0; i < joks.length; i++) {
                                wilds.push(joks[i]);
                            }
                            return wilds;
                        }
                    } else {
                        for (var i = 0; i < joks.length; i++) {
                            firsts.push(joks[i]);
                        }
                        return firsts;
                    }
                }
            }

            playing_phase() {
                var choice, choices, played, player, starter;
                starter = (this.dealer + 1) % 4;

                for (var i = 0; i < this.cards_dealt; i += 1) {
                
                    played = [];

                    for (var j = 0; j < 4; j += 1) {
                        player = (starter + j) % 4;
                        choices = this.playable(player, this.get_wildsuit(), this.first_suit);

                        if (player === 0) {
                            choices = this.playable(player, this.get_wildsuit(), this.first_suit);
                            choice = choices[this.ask_card_choice(choices.length)]; 
                            // ask_card_choice still needs to be implemented
                        } else {
                            choice = this.get_card_choice(player, played, starter);
                        }

                        this.users[player].cards.remove(choice);
                        played.push(choice);

                        if (j === 0) {
                            this.first_suit = choice.suit;
                        }
                    }

                    played = played.slice(4 - starter) + played.slice(0, 4 - starter);
                    starter = this.compute_winner(played);
                    this.users[starter].taken += 1;
                    this.first_suit = null;
                }

                for (var i = 0; i < 4; i += 1) {
                    this.users[i].score += this.get_player_score(i);
                }
            }

            reset_users() {
                for (var i = 0; i < self.users.length; i += 1) {
                    self.users[i].called = 0;
                    self.users[i].taken = 0;
                    self.users[i].cards = [];
                }
            }

            get_player_score(player_id) {
                var called, player, taken;
                player = this.users[player_id];
                called = player.called;
                taken = player.taken;

                if (taken === 0 && called > 0) {
                    return -200;
                } else {
                    if (taken !== called) {
                        return taken * 10;
                    } else {
                        if (taken === this.cards_dealt) {
                            return taken * 100;
                        } else {
                            return taken * 50 + 50;
                        }
                    }
                }
            }

            set_random_calls() {
                var already, call, calls, id;
                calls = [];
                already = 0;

                for (var i = 1; i < 5; i += 1) {
                    id = (this.dealer + i) % 4;
                    if (i === 4) {
                        call = this.get_random_call(already);
                    } else {
                        call = this.get_random_call(null);
                        already += call;
                    }
                    calls.push(call);
                }
                this.set_calls(calls[0], calls[1], calls[2], calls[3]);
            }
            
            


        }

        var deck = new StandardJokerDeck();
        var player = new Player(0);
        var game = new Game();

        
        // console.log(player.id);















        var $container = document.getElementById('container');
        var deck = Deck();
        console.log(deck.cards)
        // Select the first card
        var card = deck.cards[0];

        // Add it to an html container
        // deck.mount($container);

        card.mount($container)

        // Allow to move/drag it
        card.enableDragging();

        // Allow to flip it
        card.setSide('front')

        var $topbar = document.getElementById('topbar')

        var $sort = document.createElement('button')
        var $shuffle = document.createElement('button')
        var $bysuit = document.createElement('button')
        var $fan = document.createElement('button')
        var $poker = document.createElement('button')
        var $flip = document.createElement('button')

        $shuffle.textContent = 'Shuffle'
        $sort.textContent = 'Sort'
        $bysuit.textContent = 'By suit'
        $fan.textContent = 'Fan'
        $poker.textContent = 'Poker'
        $flip.textContent = 'Flip'

        $topbar.appendChild($flip)
        $topbar.appendChild($shuffle)
        $topbar.appendChild($bysuit)
        $topbar.appendChild($fan)
        $topbar.appendChild($poker)
        $topbar.appendChild($sort)


    </script>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
</html>  